<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo Electr√≥nico - Bodega UFRO</title>
    
    <!-- Anti-cache headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Modal de Login -->
    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-ufro text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-lock me-2"></i>Acceso Cat√°logo UFRO
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Usuario</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Contrase√±a</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-ufro">
                                <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesi√≥n
                            </button>
                        </div>
                    </form>
                    <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header para Invitado -->
    <div class="invitado-header d-none" id="invitadoHeader">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-6 fw-bold">
                        <i class="fas fa-boxes me-3"></i>Cat√°logo UFRO
                    </h1>
                    <p class="lead mb-0">Catalogo Economia Circular - Universidad de La Frontera</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="user-badge role-invitado me-3">
                        <i class="fas fa-user me-1"></i>Modo Comprador
                    </span>
                    <button class="btn btn-outline-light btn-sm" id="btnLoginFromInvitado">
                        <i class="fas fa-sign-in-alt me-1"></i>Iniciar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navbar Principal -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-ufro d-none" id="mainNavbar">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-boxes me-2"></i>Cat√°logo UFRO
            </span>
            
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="userInfo">
                    <!-- Se llenar√° din√°micamente -->
                </span>
                <button class="btn btn-outline-light btn-sm" id="btnLogout">
                    <!-- El texto cambiar√° seg√∫n el estado -->
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="container-fluid mt-4" id="mainContent">
        
        <!-- Estad√≠sticas -->
        <div class="row mb-4 d-none" id="statsSection">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-bar me-2"></i>Estad√≠sticas del Inventario
                        </h5>
                        <div class="row text-center" id="statsCards">
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number">0</div>
                                    <div class="stat-label">Total Items</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number text-success">0</div>
                                    <div class="stat-label">En Buen Estado</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number text-warning">0</div>
                                    <div class="stat-label">Estado Regular</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number text-danger">0</div>
                                    <div class="stat-label">En Mal Estado</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number text-secondary">0</div>
                                    <div class="stat-label">Inactivos</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number text-primary">$0</div>
                                    <div class="stat-label">Valor Total</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros y B√∫squeda -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchInput" placeholder="Buscar por nombre, c√≥digo o descripci√≥n...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="categoryFilter">
                                    <option value="">Todas las categor√≠as</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter">
                                    <option value="">Todos los estados</option>
                                    <option value="bueno">Bueno</option>
                                    <option value="regular">Regular</option>
                                    <option value="malo">Malo</option>
                                    <option value="inactivo">Inactivo</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-ufro w-100 d-none" id="btnNewItem">
                                    <i class="fas fa-plus me-1"></i>Nuevo Item
                                </button>
                                <div class="text-center" id="invitadoMessage">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Inicia sesi√≥n para m√°s opciones
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n para Invitados -->
        <div class="row mb-4 d-none" id="invitadoInfo">
            <div class="col-12">
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle fa-2x me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Est√°s navegando en modo Comprador</h6>
                            <p class="mb-0">Puedes ver el cat√°logo completo pero necesitas iniciar sesi√≥n para agregar, editar o eliminar items.</p>
                        </div>
                        <button class="btn btn-outline-info btn-sm ms-auto" id="btnLoginFromAlert">
                            <i class="fas fa-sign-in-alt me-1"></i>Iniciar Sesi√≥n
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- üîÑ NUEVA: Secci√≥n de Gesti√≥n de Solicitudes (solo visible para usuarios logueados) -->
        <div class="row mb-4 d-none" id="solicitudesSection">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-inbox me-2"></i>Gesti√≥n de Solicitudes
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filtros de solicitudes -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select class="form-select" id="solicitudEstadoFilter">
                                    <option value="">Todos los estados</option>
                                    <option value="pendiente">Pendientes</option>
                                    <option value="en_proceso">En Proceso</option>
                                    <option value="aprobada">Aprobadas</option>
                                    <option value="rechazada">Rechazadas</option>
                                    <option value="completada">Completadas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-success" id="btnActualizarSolicitudes">
                                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Estad√≠sticas de solicitudes -->
                        <div class="row mb-4" id="solicitudesStats">
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number">0</div>
                                    <div class="stat-label">Total</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number text-warning">0</div>
                                    <div class="stat-label">Pendientes</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number text-info">0</div>
                                    <div class="stat-label">En Proceso</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number text-success">0</div>
                                    <div class="stat-label">Aprobadas</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number text-danger">0</div>
                                    <div class="stat-label">Rechazadas</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <div class="stat-number text-secondary">0</div>
                                    <div class="stat-label">Completadas</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de solicitudes -->
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Solicitante</th>
                                        <th>Item</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="solicitudesTableBody">
                                    <!-- Las solicitudes se cargar√°n aqu√≠ -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Paginaci√≥n de solicitudes -->
                        <div id="solicitudesPagination" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid de Items -->
        <div class="row" id="itemsGrid">
            <div class="col-12 text-center py-5">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">Cargando items...</h4>
                <p class="text-muted">Espere mientras se cargan los datos del inventario.</p>
            </div>
        </div>

        <!-- üîÑ Contenedor para paginaci√≥n de items -->
        <div id="paginationContainer" class="mt-4 mb-5"></div>
    </div>

    <!-- Modal para Detalles de Item -->
    <div class="modal fade" id="itemDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-ufro text-white">
                    <h5 class="modal-title" id="itemDetailsTitle">
                        <i class="fas fa-info-circle me-2"></i>Detalles del Item
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="itemDetailsContent" style="max-height: 80vh; overflow-y: auto;">
                    <div class="text-center py-4">
                        <div class="spinner-border text-ufro" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando detalles del item...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cerrar
                    </button>
                    <!-- üîÑ NUEVO: Bot√≥n para solicitar item (solo para invitados) -->
                    <button type="button" class="btn btn-info d-none" id="btnSolicitarDesdeDetalles">
                        <i class="fas fa-hand-paper me-1"></i>Solicitar este Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Eliminar -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminaci√≥n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                        <h5>¬øEst√°s seguro de eliminar este item?</h5>
                    </div>
                    <div class="alert alert-warning">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Advertencia:</strong> Esta acci√≥n no se puede deshacer. El item ser√° marcado como inactivo en el sistema.
                        </small>
                    </div>
                    <div id="deleteItemInfo" class="bg-light p-3 rounded">
                        <!-- La informaci√≥n del item se cargar√° aqu√≠ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" id="btnConfirmDelete">
                        <i class="fas fa-trash me-1"></i>Eliminar Definitivamente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Item -->
    <div class="modal fade" id="editItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Editar Item
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editItemForm">
                        <input type="hidden" id="edit-item-id">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="edit-codigo_ufro" class="form-label">C√≥digo UFRO *</label>
                                <input type="text" class="form-control" id="edit-codigo_ufro" required>
                                <div class="form-text">C√≥digo √∫nico de identificaci√≥n</div>
                            </div>
                            <div class="col-md-6">
                                <label for="edit-nombre" class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="edit-nombre" required>
                            </div>
                            <div class="col-12">
                                <label for="edit-descripcion" class="form-label">Descripci√≥n</label>
                                <textarea class="form-control" id="edit-descripcion" rows="3" placeholder="Descripci√≥n detallada del item..."></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="edit-categoria_id" class="form-label">Categor√≠a</label>
                                <select class="form-select" id="edit-categoria_id">
                                    <option value="">Seleccionar categor√≠a</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="edit-estado" class="form-label">Estado</label>
                                <select class="form-select" id="edit-estado">
                                    <option value="bueno">Bueno</option>
                                    <option value="regular">Regular</option>
                                    <option value="malo">Malo</option>
                                    <option value="inactivo">Inactivo</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="edit-cantidad" class="form-label">Cantidad</label>
                                <input type="number" class="form-control" id="edit-cantidad" value="1" min="1">
                            </div>
                            <div class="col-md-4">
                                <label for="edit-valor_aproximado" class="form-label">Valor Aproximado ($)</label>
                                <input type="number" class="form-control" id="edit-valor_aproximado" step="0.01" placeholder="0.00">
                            </div>
                            <div class="col-md-4">
                                <label for="edit-fecha_adquisicion" class="form-label">Fecha Adquisici√≥n</label>
                                <input type="date" class="form-control" id="edit-fecha_adquisicion">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-marca" class="form-label">Marca</label>
                                <input type="text" class="form-control" id="edit-marca" placeholder="Marca del producto">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-modelo" class="form-label">Modelo</label>
                                <input type="text" class="form-control" id="edit-modelo" placeholder="Modelo del producto">
                            </div>
                            <div class="col-12" id="ubicacionEdicionSection">
                                <label for="edit-ubicacion_bodega" class="form-label">Ubicaci√≥n en Bodega</label>
                                <select class="form-select" id="edit-ubicacion_bodega">
                                    <option value="Bodega de rezago">Bodega de rezago</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>

                            <!-- IM√ÅGENES EXISTENTES -->
                            <div class="col-12" id="existingImagesSection">
                                <label class="form-label">Im√°genes Actuales</label>
                                <div id="existingImages" class="existing-images-container mb-3"></div>
                            </div>
                            
                            <!-- AGREGAR M√ÅS IM√ÅGENES -->
                            <div class="col-12">
                                <label for="edit-imagenes" class="form-label">Agregar M√°s Im√°genes</label>
                                <input type="file" class="form-control" id="edit-imagenes" multiple 
                                       accept="image/jpeg, image/png, image/gif, image/webp">
                                <div class="form-text">
                                    Puedes seleccionar hasta 5 im√°genes adicionales. Formatos: JPG, PNG, GIF, WebP (m√°x. 5MB cada una)
                                </div>
                            </div>
                            
                            <!-- PREVIEW DE NUEVAS IM√ÅGENES -->
                            <div class="col-12">
                                <div id="imagePreviewEdit" class="image-preview-container"></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" id="btnUpdateItem">
                        <i class="fas fa-save me-1"></i>Actualizar Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nuevo Item -->
    <div class="modal fade" id="newItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Nuevo Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newItemForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="codigo_ufro" class="form-label">C√≥digo UFRO *</label>
                                <input type="text" class="form-control" id="codigo_ufro" required>
                                <div class="form-text">C√≥digo √∫nico de identificaci√≥n</div>
                            </div>
                            <div class="col-md-6">
                                <label for="nombre" class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="nombre" required>
                            </div>
                            <div class="col-12">
                                <label for="descripcion" class="form-label">Descripci√≥n</label>
                                <textarea class="form-control" id="descripcion" rows="3" placeholder="Descripci√≥n detallada del item..."></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="categoria_id" class="form-label">Categor√≠a</label>
                                <select class="form-select" id="categoria_id">
                                    <option value="">Seleccionar categor√≠a</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="estado" class="form-label">Estado</label>
                                <select class="form-select" id="estado">
                                    <option value="bueno">Bueno</option>
                                    <option value="regular">Regular</option>
                                    <option value="malo">Malo</option>
                                    <option value="inactivo">Inactivo</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="cantidad" class="form-label">Cantidad</label>
                                <input type="number" class="form-control" id="cantidad" value="1" min="1">
                            </div>
                            <div class="col-md-4">
                                <label for="valor_aproximado" class="form-label">Valor Aproximado ($)</label>
                                <input type="number" class="form-control" id="valor_aproximado" step="0.01" placeholder="0.00">
                            </div>
                            <div class="col-md-4">
                                <label for="fecha_adquisicion" class="form-label">Fecha Adquisici√≥n</label>
                                <input type="date" class="form-control" id="fecha_adquisicion">
                            </div>
                            <div class="col-md-6">
                                <label for="marca" class="form-label">Marca</label>
                                <input type="text" class="form-control" id="marca" placeholder="Marca del producto">
                            </div>
                            <div class="col-md-6">
                                <label for="modelo" class="form-label">Modelo</label>
                                <input type="text" class="form-control" id="modelo" placeholder="Modelo del producto">
                            </div>
                            <div class="col-12">
                                <label for="ubicacion_bodega" class="form-label">Ubicaci√≥n en Bodega</label>
                                <select class="form-select" id="ubicacion_bodega">
                                    <option value="Bodega de rezago">Bodega de rezago</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>

                            <!-- CAMPO PARA IM√ÅGENES -->
                            <div class="col-12">
                                <label for="imagenes" class="form-label">Im√°genes del Item</label>
                                <input type="file" class="form-control" id="imagenes" multiple 
                                       accept="image/jpeg, image/png, image/gif, image/webp">
                                <div class="form-text">
                                    Puedes seleccionar hasta 5 im√°genes. Formatos permitidos: JPG, PNG, GIF, WebP (m√°x. 5MB cada una)
                                </div>
                            </div>
                            
                            <!-- PREVIEW DE IM√ÅGENES -->
                            <div class="col-12">
                                <div id="imagePreviewNew" class="image-preview-container"></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-ufro" id="btnSaveItem">
                        <i class="fas fa-save me-1"></i>Guardar Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- üîÑ NUEVO: Modal para Solicitar Item -->
    <div class="modal fade" id="solicitarItemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-hand-paper me-2"></i>Solicitar Item
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="solicitarItemForm">
                        <input type="hidden" id="solicitar-item-id">
                        
                        <div class="mb-3">
                            <label for="solicitar-nombre" class="form-label">Nombre Completo *</label>
                            <input type="text" class="form-control" id="solicitar-nombre" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="solicitar-email" class="form-label">Email Institucional *</label>
                            <input type="email" class="form-control" id="solicitar-email" required
                                   placeholder="nombre@ufro.cl">
                        </div>
                        
                        <div class="mb-3">
                            <label for="solicitar-telefono" class="form-label">Tel√©fono de Contacto</label>
                            <input type="tel" class="form-control" id="solicitar-telefono"
                                   placeholder="+56 9 1234 5678">
                        </div>
                        
                        <div class="mb-3">
                            <label for="solicitar-departamento" class="form-label">Departamento/Facultad</label>
                            <input type="text" class="form-control" id="solicitar-departamento"
                                   placeholder="Ej: Facultad de Ingenier√≠a">
                        </div>
                        
                        <div class="mb-3">
                            <label for="solicitar-motivo" class="form-label">Motivo de la Solicitud *</label>
                            <textarea class="form-control" id="solicitar-motivo" rows="3" required
                                      placeholder="Explique para qu√© necesita este item..."></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Esta solicitud ser√° revisada por el personal correspondiente. 
                                Se contactar√°n con usted por email.
                            </small>
                        </div>
                    </form>
                    
                    <div id="solicitudInfo" class="mt-3" style="display: none;">
                        <div class="alert alert-light border">
                            <h6>Informaci√≥n del Item:</h6>
                            <div id="solicitudItemInfo"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-info" id="btnEnviarSolicitud">
                        <i class="fas fa-paper-plane me-1"></i>Enviar Solicitud
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- üîÑ NUEVO: Modal para Ver/Editar Solicitud -->
    <div class="modal fade" id="verSolicitudModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" id="solicitudModalHeader">
                    <h5 class="modal-title">
                        <i class="fas fa-file-alt me-2"></i>Detalles de Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="solicitudModalContent">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cerrar
                    </button>
                    <button type="button" class="btn btn-danger d-none" id="btnEliminarSolicitud">
                        <i class="fas fa-trash me-1"></i>Eliminar
                    </button>
                    <div class="btn-group">
                        <button type="button" class="btn btn-warning" id="btnRechazarSolicitud">
                            <i class="fas fa-times-circle me-1"></i>Rechazar
                        </button>
                        <button type="button" class="btn btn-success" id="btnAprobarSolicitud">
                            <i class="fas fa-check-circle me-1"></i>Aprobar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast para mensajes -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="messageToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle me-2" id="toastIcon"></i>
                <strong class="me-auto" id="toastTitle">Mensaje</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // Configurar eventos adicionales para los botones de login desde invitado
        document.addEventListener('DOMContentLoaded', function() {
            // Bot√≥n de login desde el header de invitado
            document.getElementById('btnLoginFromInvitado').addEventListener('click', function() {
                catalogoApp.mostrarLogin();
            });
            
            // Bot√≥n de login desde el alert de invitado
            document.getElementById('btnLoginFromAlert').addEventListener('click', function() {
                catalogoApp.mostrarLogin();
            });

            // Eventos para previsualizaci√≥n de im√°genes
            document.getElementById('imagenes').addEventListener('change', function(e) {
                previewImages(this, 'imagePreviewNew');
            });

            document.getElementById('edit-imagenes').addEventListener('change', function(e) {
                previewImages(this, 'imagePreviewEdit');
            });

            // üîÑ NUEVO: Configurar eventos para sistema de solicitudes
            document.getElementById('btnEnviarSolicitud')?.addEventListener('click', function() {
                catalogoApp.enviarSolicitud();
            });

            document.getElementById('btnActualizarSolicitudes')?.addEventListener('click', function() {
                const estado = document.getElementById('solicitudEstadoFilter').value;
                catalogoApp.cargarSolicitudes(estado);
            });

            document.getElementById('solicitudEstadoFilter')?.addEventListener('change', function() {
                const estado = this.value;
                catalogoApp.cargarSolicitudes(estado);
            });

            // Eventos para modal de solicitud detallada
            document.getElementById('btnAprobarSolicitud')?.addEventListener('click', function() {
                catalogoApp.cambiarEstadoSolicitud('aprobada');
            });

            document.getElementById('btnRechazarSolicitud')?.addEventListener('click', function() {
                catalogoApp.cambiarEstadoSolicitud('rechazada');
            });

            document.getElementById('btnEliminarSolicitud')?.addEventListener('click', function() {
                catalogoApp.eliminarSolicitud();
            });
        });

        // Funci√≥n para previsualizar im√°genes antes de subir
        function previewImages(input, previewContainerId) {
            const previewContainer = document.getElementById(previewContainerId);
            previewContainer.innerHTML = '';
            
            if (input.files && input.files.length > 0) {
                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'image-preview-item';
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" alt="Preview">
                            <button type="button" class="remove-image" onclick="removeImagePreview(this, ${i})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        previewContainer.appendChild(previewItem);
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        }

        // Funci√≥n para remover previsualizaci√≥n
        function removeImagePreview(button, index) {
            const input = document.getElementById('imagenes') || document.getElementById('edit-imagenes');
            const dt = new DataTransfer();
            const files = Array.from(input.files);
            
            // Remover el archivo del array
            files.splice(index, 1);
            
            // Actualizar el input files
            files.forEach(file => dt.items.add(file));
            input.files = dt.files;
            
            // Remover la previsualizaci√≥n
            button.parentElement.remove();
        }

        // ELIMINAR IMAGEN EXISTENTE
        async function deleteExistingImage(itemId, filename) {
            if (!confirm('¬øEst√°s seguro de eliminar esta imagen?')) return;
            
            try {
                console.log('üóëÔ∏è Eliminando imagen:', filename, 'del item:', itemId);
                
                // Verificar que tenemos un token v√°lido
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No est√°s autenticado. Inicia sesi√≥n nuevamente.');
                }
                
                console.log('üîë Token disponible, enviando solicitud...');
                
                const response = await fetch(`/api/items/${itemId}/imagenes/${filename}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Respuesta del servidor:', response.status, response.statusText);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Imagen eliminada:', result);
                    
                    // Mostrar mensaje de √©xito
                    if (window.catalogoApp) {
                        window.catalogoApp.mostrarToast('Imagen eliminada correctamente', 'success');
                        
                        // Recargar el modal de edici√≥n si est√° abierto
                        const editModal = bootstrap.Modal.getInstance(document.getElementById('editItemModal'));
                        if (editModal) {
                            // Actualizar las im√°genes existentes en el modal
                            const existingImagesContainer = document.getElementById('existingImages');
                            if (existingImagesContainer) {
                                // Filtrar la imagen eliminada del DOM
                                const imageElements = existingImagesContainer.querySelectorAll('.existing-image-item');
                                imageElements.forEach(element => {
                                    const img = element.querySelector('img');
                                    if (img && img.src.includes(filename)) {
                                        element.remove();
                                    }
                                });
                                
                                // Si no quedan im√°genes, mostrar mensaje
                                if (existingImagesContainer.children.length === 0) {
                                    existingImagesContainer.innerHTML = '<p class="text-muted">No hay im√°genes para este item.</p>';
                                }
                            }
                        }
                        
                        // Recargar la lista de items para actualizar las cards
                        setTimeout(() => {
                            window.catalogoApp.cargarItems();
                        }, 500);
                    }
                } else {
                    // Manejar diferentes c√≥digos de error
                    if (response.status === 401) {
                        throw new Error('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
                    } else if (response.status === 403) {
                        throw new Error('No tienes permisos para eliminar im√°genes.');
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error eliminando imagen:', error);
                
                // Mostrar mensaje de error espec√≠fico
                if (window.catalogoApp) {
                    window.catalogoApp.mostrarToast(error.message, 'error');
                    
                    // Si es error de autenticaci√≥n, redirigir al login
                    if (error.message.includes('Sesi√≥n expirada') || error.message.includes('No est√°s autenticado')) {
                        setTimeout(() => {
                            window.catalogoApp.mostrarLogin();
                        }, 2000);
                    }
                }
            }
        }

        // Funci√≥n para mostrar im√°genes existentes en edici√≥n (compatibilidad)
        function renderExistingImages(images, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (images && images.length > 0) {
                images.forEach((img, index) => {
                    const imageUrl = `/uploads/items/${img.filename}`;
                    const imageItem = document.createElement('div');
                    imageItem.className = 'existing-image-item';
                    imageItem.innerHTML = `
                        <img src="${imageUrl}" alt="${img.originalname}">
                        <button type="button" class="delete-existing-image" 
                                onclick="deleteExistingImage(${img.itemId || document.getElementById('edit-item-id').value}, '${img.filename}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    container.appendChild(imageItem);
                });
            } else {
                container.innerHTML = '<p class="text-muted">No hay im√°genes para este item.</p>';
            }
        }
    </script>
</body>
</html>